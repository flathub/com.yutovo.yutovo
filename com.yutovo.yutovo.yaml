app-id: com.yutovo.yutovo
runtime: org.kde.Platform
runtime-version: '5.15-24.08'
sdk: org.kde.Sdk
command: run.sh
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  - --filesystem=xdg-documents
build-options:
  strip: true
  no-debuginfo: true
cleanup:
  - /app/include
  - /include
  - /lib
  - /lib64
  - /share/doc
rename-desktop-file: yutovo.desktop
rename-icon: yutovo
rename-mime-file: yutovo.xml
modules:
  - name: spdlog
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/gabime/spdlog.git
        tag: v1.15.3
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release

  - name: yutovo-logger
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-logger.git
        tag: v1.0.6
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 headers
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.83.0/source/boost_1_83_0.zip
        sha256: c86bd9d9eef795b4b0d3802279419fde5221922805b073b9bd822edecb1ca28e
    post-install:
      - install -d /app/include
      - cp -r boost /app/include/

  - name: gmp
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/sethtroisi/libgmp.git
        commit: 21623db
    build-commands:
      - ./.bootstrap
      - ./configure --enable-static --disable-shared --enable-cxx --libdir=/app/lib/ --prefix=/app/
      - make -sj && make install

  - name: mpfr
    buildsystem: simple
    sources:
      - type: archive
        url: https://www.mpfr.org/mpfr-4.2.1/mpfr-4.2.1.tar.gz
        sha256: 116715552bd966c85b417c424db1bbdf639f53836eb361549d1f8d6ded5cb4c6
    build-commands:
      - ./configure --enable-static --disable-shared --enable-cxx --libdir=/app/lib/ --prefix=/app/
      - make -sj && make install

  - name: yutovo-calculator
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-calculator.git
        tag: v1.3.5
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF

  - name: rapidjson
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/Tencent/rapidjson.git
        tag: v1.1.0
      - type: patch
        path: ./document.h.diff
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DRAPIDJSON_BUILD_DOC=OFF
      - -DRAPIDJSON_BUILD_EXAMPLES=OFF
      - -DRAPIDJSON_BUILD_TESTS=OFF
      - -DRAPIDJSON_BUILD_THIRDPARTY_GTEST=OFF

  - name: yutovo-solver
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-solver.git
        tag: v1.1.7
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release

  - name: mathgl
    buildsystem: cmake
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/mathgl/mathgl-8.0.3.tar.gz
        sha256: 9bba9ee6a0f86d1b8f3f3ba0374d3cb776f772dbb6f1a01684ca6c0bd56204d6
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_INSTALL_LIBDIR=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -Denable-openmp=False
      - -Denable-png=False
      - -Denable-opengl=False
    post-install:
      - cp /app/lib/libmgl.so.8 /app/bin/
      - rm -rf /app/share/mathgl

  - name: libharu
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/libharu/libharu.git
        tag: v2.4.4
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=OFF
    post-install:
      - |
        if [ -f /app/lib64/libhpdf.a ]; then
          mv /app/lib64/libhpdf.a /app/lib/
        fi

  - name: stb_image
    buildsystem: simple
    sources:
      - type: file
        url: https://raw.githubusercontent.com/nothings/stb/master/stb_image.h
        sha256: 594c2fe35d49488b4382dbfaec8f98366defca819d916ac95becf3e75f4200b3
      - type: file
        url: https://raw.githubusercontent.com/nothings/stb/master/stb_image_write.h
        sha256: cbd5f0ad7a9cf4468affb36354a1d2338034f2c12473cf1a8e32053cb6914a05
    build-commands:
      - mkdir -p /app/include/stb_image
      - install -Dm644 stb_image.h /app/include/stb_image/stb_image.h
      - install -Dm644 stb_image_write.h /app/include/stb_image/stb_image_write.h
    cleanup:
      - "*.h"

  - name: yutovo-editor
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
        THIRD_PARTY_PATH: ""
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-editor.git
        tag: v1.4.3
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF

  - name: yutovo-server
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-server.git
        tag: v1.1.10
    build-commands:
      - mkdir -p /app/bin
      - cp -r $FLATPAK_BUILDER_BUILDDIR/library /app/bin

  - name: yutovo-desktop
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
        THIRD_PARTY_PATH: ""
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-desktop.git
        tag: v1.4.3
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
    post-install:
      - mkdir -p /app/share/mime/packages
      - mkdir -p /app/share/metainfo
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/com.yutovo.yutovo.metainfo.xml /app/share/metainfo/
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo.xml /app/share/mime/packages/yutovo.xml
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo-16.png /app/share/icons/hicolor/16x16/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo-32.png /app/share/icons/hicolor/32x32/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo-64.png /app/share/icons/hicolor/64x64/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo.png /app/share/icons/hicolor/256x256/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo.desktop /app/share/applications/yutovo.desktop
      - update-mime-database /app/share/mime
      - update-desktop-database /app/share/applications
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/Flatpak/run.sh /app/bin/run.sh
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/src/*.qm /app/bin/
      - chmod +x /app/bin/run.sh
