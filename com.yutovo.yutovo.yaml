app-id: com.yutovo.yutovo
runtime: org.kde.Platform
runtime-version: '5.15-24.08'
sdk: org.kde.Sdk
command: run.sh
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  - --filesystem=xdg-documents
build-options:
  strip: true
  no-debuginfo: true
cleanup:
  - /include
  - /lib
  - /lib64
  - /share/doc
rename-desktop-file: yutovo.desktop
rename-icon: yutovo
rename-mime-file: yutovo.xml
modules:
  - name: spdlog
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/gabime/spdlog.git
        tag: v1.15.3
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release

  - name: yutovo-logger
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-logger.git
        tag: v1.0.4
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=iostreams
      - ./b2 -j $FLATPAK_BUILDER_N_JOBS install link=static variant=release cxxflags='-fPIE -fstack-protector-strong -D_FORTIFY_SOURCE=2' --layout=system
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.83.0/source/boost_1_83_0.zip
        sha256: c86bd9d9eef795b4b0d3802279419fde5221922805b073b9bd822edecb1ca28e

  - name: gmp
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/sethtroisi/libgmp.git
        commit: 21623db
    build-commands:
      - ./.bootstrap
      - ./configure --enable-static --disable-shared --enable-cxx --libdir=/app/lib/ --prefix=/app/
      - make -sj && make install

  - name: mpfr
    buildsystem: simple
    sources:
      - type: git
        url: https://gitlab.inria.fr/mpfr/mpfr.git
        tag: 4.2.1
    build-commands:
      - ./autogen.sh
      - ./configure --enable-static --disable-shared --prefix=/app/ --with-gmp=/app/include/
      - make -sj && make install

  - name: yutovo-calculator
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-calculator.git
        tag: v1.3.1
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF

  - name: rapidjson
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/Tencent/rapidjson.git
        tag: v1.1.0
      - type: patch
        path: document.h.diff
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DRAPIDJSON_BUILD_DOC=OFF
      - -DRAPIDJSON_BUILD_EXAMPLES=OFF
      - -DRAPIDJSON_BUILD_TESTS=OFF
      - -DRAPIDJSON_BUILD_THIRDPARTY_GTEST=OFF

  - name: yutovo-solver
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-solver.git
        tag: v1.1.5
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release

  - name: mathgl
    buildsystem: cmake
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/mathgl/mathgl-8.0.3.tar.gz
        sha256: 9bba9ee6a0f86d1b8f3f3ba0374d3cb776f772dbb6f1a01684ca6c0bd56204d6
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_INSTALL_LIBDIR=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -Denable-openmp=False
      - -Denable-png=False
      - -Denable-opengl=False
    post-install:
      - cp /app/lib/libmgl.so.8 /app/bin/

  - name: yutovo-editor
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-editor.git
        tag: v1.3.1
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF

  - name: yutovo-server
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-server.git
        tag: v1.1.5
    build-commands:
      - mkdir -p /app/bin
      - cp -r $FLATPAK_BUILDER_BUILDDIR/library /app/bin

  - name: yutovo-desktop
    buildsystem: cmake
    build-options:
      env:
        YUTOVO_DEPLOY: /app
    sources:
      - type: git
        url: https://github.com/denprog/yutovo-desktop.git
        tag: v1.3.1
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
    post-install:
      - mkdir -p /app/share/mime/packages
      - mkdir -p /app/share/metainfo
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/com.yutovo.yutovo.metainfo.xml /app/share/metainfo/
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo.xml /app/share/mime/packages/yutovo.xml
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo-16.png /app/share/icons/hicolor/16x16/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo-32.png /app/share/icons/hicolor/32x32/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo-64.png /app/share/icons/hicolor/64x64/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo.png /app/share/icons/hicolor/256x256/apps/yutovo.png
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/yutovo.desktop /app/share/applications/yutovo.desktop
      - update-mime-database /app/share/mime
      - update-desktop-database /app/share/applications
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/setup/Flatpak/run.sh /app/bin/run.sh
      - install -Dm644 $FLATPAK_BUILDER_BUILDDIR/src/*.qm /app/bin/
      - chmod +x /app/bin/run.sh
